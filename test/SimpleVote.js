// =============================================================
// SimpleVote.test.jsï¼ˆHardhatï¼‰
// -------------------------------------------------------------
// ã€ŒSimpleVote.solã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€‚
// Hardhatï¼ˆEthers.js v6 + Mocha + Chaiï¼‰ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã‚’æ¤œè¨¼ã—ã¾ã™ï¼š
//   1. ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§è¨­å®šã—ãŸåˆæœŸãƒˆãƒ”ãƒƒã‚¯ãŒæ­£ã—ã„ã‹
//   2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ•ç¥¨ã‚’è¨˜éŒ²ã§ãã‚‹ã‹
//   3. äºŒé‡æŠ•ç¥¨ï¼ˆåŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é‡è¤‡æŠ•ç¥¨ï¼‰ãŒæ‹’å¦ã•ã‚Œã‚‹ã‹
// =============================================================

// Chai ã® expect é–¢æ•°ï¼šå€¤ãŒæœŸå¾…ã©ãŠã‚Šã‹ã‚’æ¤œè¨¼ã™ã‚‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ç”¨
const { expect } = require('chai');
// Hardhat ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«æ³¨å…¥ã™ã‚‹ Ethers.jsï¼ˆv6ï¼‰
const { ethers } = require('hardhat');

// ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã€‚ã€ŒSimpleVoteã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«é–¢ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’ã¾ã¨ã‚ã‚‹
describe('SimpleVote', () => {
    // ã“ã“ã§å®£è¨€ã—ãŸå¤‰æ•°ã¯ describe ã‚¹ã‚³ãƒ¼ãƒ—å…¨ä½“ã§å‚ç…§å¯èƒ½
    let vote; // ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    let owner; // ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰
    let addr1; // ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ 1
    let addr2; // ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ 2

    // beforeEach ãƒ•ãƒƒã‚¯ï¼šå„ãƒ†ã‚¹ãƒˆ(it)ã®å‰ã«å¿…ãšå®Ÿè¡Œ
    // æ¯å›ã‚¯ãƒªãƒ¼ãƒ³ãªç’°å¢ƒã§ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã§ã€
    // ãƒ†ã‚¹ãƒˆåŒå£«ãŒå¹²æ¸‰ã›ãšç‹¬ç«‹ã—ã¦å‹•ãã‚ˆã†ã«ã™ã‚‹
    beforeEach(async () => {
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ•ã‚¡ã‚¯ãƒˆãƒªã‚’å–å¾—ï¼ˆABI + ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
        const Vote = await ethers.getContractFactory('SimpleVote');
        // Hardhat ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒç”¨æ„ã—ãŸãƒ€ãƒŸãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ 3 ã¤å–å¾—
        [owner, addr1, addr2] = await ethers.getSigners();
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ã«ãƒˆãƒ”ãƒƒã‚¯åã‚’æ¸¡ã™
        vote = await Vote.deploy('Cats vs Dogs');
        // ethers v6ï¼šãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…ã¤å°‚ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
        await vote.waitForDeployment();
    });

    // =========================================================
    // ğŸ“ ãƒ†ã‚¹ãƒˆ 1: åˆæœŸãƒˆãƒ”ãƒƒã‚¯ãŒæ­£ã—ã„
    // =========================================================
    it('åˆæœŸãƒˆãƒ”ãƒƒã‚¯ãŒæ­£ã—ã„ã“ã¨', async () => {
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®çŠ¶æ…‹å¤‰æ•° topic ãŒæœŸå¾…å€¤ã¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
        expect(await vote.topic()).to.equal('Cats vs Dogs');
    });

    // =========================================================
    // ğŸ“ ãƒ†ã‚¹ãƒˆ 2: æŠ•ç¥¨ãŒè¨˜éŒ²ã•ã‚Œã‚‹ã‹
    // =========================================================
    it('æŠ•ç¥¨ã§ãã‚‹ã“ã¨', async () => {
        // addr1 ãŒã€Œè³›æˆ (true)ã€ã§æŠ•ç¥¨
        await vote.connect(addr1).vote(true);
        // getVotes() ã¯ [è³›æˆç¥¨, åå¯¾ç¥¨] ã®é…åˆ—ã‚’è¿”ã™æƒ³å®š
        const [forVotes, againstVotes] = await vote.getVotes();
        // è³›æˆç¥¨ãŒ 1ã€åå¯¾ç¥¨ãŒ 0 ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼
        expect(forVotes).to.equal(1n);
        expect(againstVotes).to.equal(0n);
    });

    // =========================================================
    // ğŸ“ ãƒ†ã‚¹ãƒˆ 3: äºŒé‡æŠ•ç¥¨ã‚’é˜²æ­¢ã§ãã‚‹ã‹
    // =========================================================
    it('äºŒé‡æŠ•ç¥¨ã‚’é˜²æ­¢ã™ã‚‹ã“ã¨', async () => {
        // ã¾ãš addr1 ãŒã€Œåå¯¾ (false)ã€ã«æŠ•ç¥¨
        await vote.connect(addr1).vote(false);
        // åŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå†åº¦æŠ•ç¥¨ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã§ revert ã•ã‚Œã‚‹ã¯ãš
        await expect(vote.connect(addr1).vote(true)).to.be.revertedWithCustomError(
            vote,
            'AlreadyVoted'
        );
    });
});
