# SimpleVote Next.js アプリケーション Playwright テスト計画

## 概要
SimpleVoteは、ブロックチェーン上で投票を行うDApp（分散型アプリケーション）です。このドキュメントでは、Next.jsで構築されたフロントエンドアプリケーションのPlaywrightテスト項目を網羅的にまとめています。

## テスト環境設定

### 必要な依存関係
```json
{
  "devDependencies": {
    "@playwright/test": "^1.40.0",
    "playwright": "^1.40.0"
  }
}
```

### テスト設定ファイル
- `playwright.config.ts` - Playwrightの設定
- `tests/` - テストファイル格納ディレクトリ

## テスト項目一覧

### 1. 基本UI・ナビゲーションテスト

#### 1.1 ホームページ（`/`）
- [x] ページタイトル「SimpleVote」が表示される
- [x] ウォレット未接続時に「ウォレット接続」ボタンが表示される
- [x] ウォレット未接続時にアカウントアドレスが表示されない
- [x] ウォレット未接続時に「切断」ボタンが表示されない
- [x] ウォレット未接続時に「新規作成」ボタンが表示されない
- [x] ウォレット未接続時に投票一覧セクションが表示されない
- [x] ウォレット接続後にアカウントアドレスが表示される
- [x] ウォレット接続後に「切断」ボタンが表示される
- [x] ウォレット接続後に「新規作成」ボタンが表示される
- [x] ウォレット接続後に投票一覧セクションが表示される
- [x] 投票が存在しない場合「議題が存在しません」が表示される
- [x] 投票一覧の各項目が正しく表示される（タイプ、トピック、ID）
- [x] 投票項目をクリックすると対応する投票ページに遷移する

#### 1.2 ページヘッダー・ナビゲーション
- [x] パンくずリストが正しく表示される
- [x] ホームボタンが正しく機能する
- [x] ホームページのタイトル表示（ウォレット未接続時）
- [x] ホームページのタイトル表示（ウォレット接続時）

#### 1.3 ローディング状態
- [x] データ読み込み中にLoadingSpinnerが表示される
- [x] 読み込み完了後にコンテンツが表示される

#### 1.4 エラーハンドリング
- [x] エラー時に適切なエラーメッセージが表示される
- [x] 無効なPoll IDでアクセスした場合のエラー表示
- [x] コントラクトアドレス未設定時のエラー表示

### 2. ウォレット接続テスト

#### 2.1 MetaMask接続
- [x] 接続成功後のアカウントアドレス表示
- [x] 接続成功後のUI状態確認
- [x] 複数回の接続試行
- [ ] ウォレット接続ボタンクリック時の動作
- [ ] 接続成功後のトーストメッセージ表示
- [ ] MetaMaskがインストールされていない場合のエラーメッセージ

#### 2.2 ウォレット切断
- [x] 切断ボタンクリック時の動作
- [x] 切断後の状態リセット
- [x] 切断後の再接続
- [ ] 切断後のトーストメッセージ表示

#### 2.3 ウォレット状態管理
- [ ] ページリロード後のウォレット状態保持
- [ ] アカウント切り替え時の状態更新
- [ ] ネットワーク切り替え時の状態更新
- [ ] ウォレット接続状態の永続化

#### 2.4 エラーハンドリング
- [ ] MetaMaskがインストールされていない場合のエラーメッセージ
- [ ] ユーザーが接続を拒否した場合のエラーハンドリング
- [ ] ネットワークエラー時のエラーハンドリング
- [ ] 無効なネットワークへの接続時のエラーハンドリング

#### 2.5 パフォーマンステスト
- [ ] ウォレット接続の応答時間
- [ ] 複数回接続時のパフォーマンス

#### 2.6 セキュリティテスト
- [x] アカウントアドレスの適切な表示
- [x] 接続状態の適切な検証
- [ ] 不正なアカウントアドレスの検証

#### 2.7 アクセシビリティテスト
- [x] ウォレット接続ボタンのアクセシビリティ
- [x] 切断ボタンのアクセシビリティ
- [ ] アカウントアドレス表示のアクセシビリティ

### 3. 投票作成テスト（`/create`）

#### 3.1 フォーム表示
- [ ] 投票タイプ選択（Dynamic Vote、Weighted Vote、Simple Vote）
- [ ] 議題入力フィールド
- [ ] 開始日時・終了日時入力フィールド
- [ ] 選択肢入力フィールド（初期値2個）
- [ ] 選択肢追加ボタン（最大10個まで）
- [ ] Weighted Vote選択時のトークンアドレス入力フィールド

#### 3.2 フォームバリデーション
- [ ] 必須項目の入力チェック
- [ ] 日時の妥当性チェック（終了日時 > 開始日時）
- [ ] トークンアドレスの形式チェック
- [ ] 選択肢の空文字チェック
- [ ] 選択肢の重複チェック

#### 3.3 フォーム操作
- [ ] 投票タイプ変更時のUI更新
- [ ] 選択肢の追加・削除
- [ ] 日時の自動設定（現在時刻から1時間後）
- [ ] フォームリセット機能

#### 3.4 投票作成実行
- [ ] 作成ボタンクリック時のトランザクション実行
- [ ] トランザクション承認待ち状態の表示
- [ ] 作成成功後のトーストメッセージ
- [ ] 作成成功後のホームページリダイレクト
- [ ] エラー時の適切なエラーメッセージ表示

### 4. Dynamic Vote テスト（`/dynamic/[pollId]`）

#### 4.1 ページ表示
- [ ] 投票タイトル「DynamicVote」の表示
- [ ] 議題内容の表示
- [ ] 開始・終了日時の表示
- [ ] 選択肢一覧の表示
- [ ] 各選択肢の投票数表示

#### 4.2 投票期間チェック
- [ ] 投票期間内の投票ボタン有効化
- [ ] 投票期間外の投票ボタン無効化
- [ ] 投票期間外メッセージの表示

#### 4.3 投票操作
- [ ] 選択肢の選択
- [ ] 投票ボタンクリック時のトランザクション実行
- [ ] 投票成功後のトーストメッセージ
- [ ] 投票後の選択肢無効化
- [ ] 投票取消ボタンの表示
- [ ] 投票取消の実行

#### 4.4 リアルタイム更新
- [ ] 投票後の投票数更新
- [ ] イベントリスナーによる自動更新
- [ ] 他のユーザーの投票反映

### 5. Weighted Vote テスト（`/weighted/[pollId]`）

#### 5.1 ページ表示
- [ ] 投票タイトル「WeightedVote DApp」の表示
- [ ] 議題内容の表示
- [ ] 開始・終了日時の表示
- [ ] 選択肢一覧の表示
- [ ] 各選択肢の投票数表示（Ether表記）

#### 5.2 トークン承認
- [ ] 投票金額入力フィールド
- [ ] トークン承認ボタンの表示
- [ ] 承認実行時のトランザクション
- [ ] 承認成功後のトーストメッセージ

#### 5.3 投票操作
- [ ] 選択肢の選択
- [ ] 投票金額の入力
- [ ] 投票ボタンクリック時のトランザクション実行
- [ ] 投票成功後のトーストメッセージ
- [ ] 投票後の選択肢無効化
- [ ] 投票取消ボタンの表示
- [ ] 投票取消の実行

#### 5.4 金額バリデーション
- [ ] 無効な金額入力のエラーハンドリング
- [ ] 残高不足時のエラーメッセージ
- [ ] 承認額不足時のエラーメッセージ

### 6. Simple Vote テスト（`/simple/[pollId]`）

#### 6.1 ページ表示
- [ ] 投票タイトル「SimpleVote」の表示
- [ ] 議題内容の表示
- [ ] 開始・終了日時の表示
- [ ] 賛成・反対の選択肢表示
- [ ] 賛成・反対の投票数表示

#### 6.2 投票操作
- [ ] 賛成・反対の選択
- [ ] 投票ボタンクリック時のトランザクション実行
- [ ] 投票成功後のトーストメッセージ
- [ ] 投票後の選択肢無効化
- [ ] 投票取消ボタンの表示
- [ ] 投票取消の実行

### 7. トースト通知テスト

#### 7.1 トースト表示
- [ ] 成功メッセージの表示
- [ ] エラーメッセージの表示
- [ ] トランザクション承認待ちメッセージの表示
- [ ] トーストの自動消去

#### 7.2 トースト操作
- [ ] 複数トーストの同時表示
- [ ] トーストの手動閉じる機能

### 8. レスポンシブデザインテスト

#### 8.1 画面サイズ対応
- [x] デスクトップ表示（1920x1080）
- [x] タブレット表示（768x1024）
- [x] モバイル表示（375x667）
- [x] 各画面サイズでのUI要素の配置確認

#### 8.2 タッチ操作
- [ ] モバイルでのタップ操作
- [ ] スワイプ操作の確認

### 9. パフォーマンステスト

#### 9.1 ページ読み込み
- [x] 初期ページ読み込み時間
- [ ] 投票一覧取得時間
- [ ] 投票詳細取得時間

#### 9.2 メモリ使用量
- [ ] 長時間使用時のメモリリーク確認
- [ ] イベントリスナーの適切なクリーンアップ

### 10. セキュリティテスト

#### 10.1 入力値検証
- [ ] XSS攻撃対策
- [ ] SQLインジェクション対策（該当する場合）
- [ ] 特殊文字の適切なエスケープ

#### 10.2 認証・認可
- [ ] 未認証ユーザーのアクセス制限
- [ ] 権限のない操作の制限

### 11. ブラウザ互換性テスト

#### 11.1 対応ブラウザ
- [x] Chrome
- [x] Firefox
- [x] Safari
- [x] Edge

#### 11.2 機能確認
- [x] 各ブラウザでの基本機能動作
- [x] 各ブラウザでのUI表示確認

### 12. エラーシナリオテスト

#### 12.1 ネットワークエラー
- [ ] ネットワーク切断時のエラーハンドリング
- [ ] ネットワーク復旧時の自動再接続

#### 12.2 コントラクトエラー
- [ ] コントラクト呼び出し失敗時のエラーハンドリング
- [ ] ガス不足時のエラーメッセージ
- [ ] 無効なトランザクションのエラーハンドリング

#### 12.3 ユーザーエラー
- [ ] 無効な入力値のエラーハンドリング
- [ ] 重複投票の防止
- [ ] 投票期間外の投票防止

## テスト実装の優先順位

### 高優先度（必須）
1. ウォレット接続テストの修正
2. 投票作成テスト
3. 各投票タイプの基本機能テスト

### 中優先度（重要）
1. エラーハンドリングテスト
2. トースト通知テスト
3. セキュリティテスト

### 低優先度（推奨）
1. パフォーマンステスト
2. エラーシナリオテスト

## テストデータ準備

### テスト用アカウント
- テスト用ウォレットアカウント（複数）
- テスト用トークン残高

### テスト用投票データ
- Dynamic Vote用のテスト投票
- Weighted Vote用のテスト投票
- Simple Vote用のテスト投票
- 投票期間内・期間外のテストデータ

### モックデータ
- コントラクトレスポンスのモック
- ネットワークエラーのモック
- トランザクション失敗のモック

## テスト実行環境

### ローカル環境
- Hardhatローカルネットワーク
- MetaMaskテストネットワーク接続
- テスト用アカウントの設定

### CI/CD環境
- GitHub Actionsでの自動テスト実行
- テスト結果のレポート生成
- カバレッジレポートの生成

## 注意事項

1. **ブロックチェーン操作**: 実際のトランザクションを実行するため、テスト用のネットワークを使用
2. **非同期処理**: ブロックチェーンの確認待ち時間を考慮したテスト設計
3. **状態管理**: ウォレット接続状態や投票状態の適切な管理
4. **エラーハンドリング**: ネットワークエラーやコントラクトエラーの適切な処理
5. **テストデータ**: テスト用の投票データやアカウントの準備

## テスト実装状況サマリー

### 実装済みテスト項目（2024年7月1日現在）
- **基本UI・ナビゲーションテスト**: 30/30項目完了（100%）
- **レスポンシブデザインテスト**: 4/4項目完了（100%）
- **アクセシビリティテスト**: 3/3項目完了（100%）
- **パフォーマンステスト**: 2/2項目完了（100%）
- **ブラウザ互換性テスト**: 4/4項目完了（100%）
- **ウォレット接続テスト**: 10/25項目完了（40%）

### 総実装済みテスト項目: 53/140項目（37.9%）

### 最新のテスト結果（2024年7月1日）
```
基本UI・ナビゲーションテスト: 30/30項目完了（100%）
ウォレット接続テスト: 10/25項目完了（40%）
総成功率: 75% (40/55)
```

## ウォレット接続テストの現在の課題

### 失敗したテスト項目（15個）

#### 2.1 MetaMask接続
- [ ] ウォレット接続ボタンクリック時の動作
- [ ] 接続成功後のトーストメッセージ表示

#### 2.2 ウォレット切断
- [ ] 切断後のトーストメッセージ表示

#### 2.3 ウォレット状態管理
- [ ] ページリロード後のウォレット状態保持
- [ ] アカウント切り替え時の状態更新
- [ ] ネットワーク切り替え時の状態更新
- [ ] ウォレット接続状態の永続化

#### 2.4 エラーハンドリング
- [ ] MetaMaskがインストールされていない場合のエラーメッセージ
- [ ] ユーザーが接続を拒否した場合のエラーハンドリング
- [ ] ネットワークエラー時のエラーハンドリング
- [ ] 無効なネットワークへの接続時のエラーハンドリング

#### 2.5 パフォーマンステスト
- [ ] ウォレット接続の応答時間
- [ ] 複数回接続時のパフォーマンス

#### 2.6 セキュリティテスト
- [ ] 不正なアカウントアドレスの検証

#### 2.7 アクセシビリティテスト
- [ ] アカウントアドレス表示のアクセシビリティ

### 主要な問題点

#### 1. Ethers.jsモックの不完全性
- `eth_newFilter`, `eth_call`, `eth_blockNumber`メソッドの未実装
- イベントエミッター機能（`window.ethereum.emit`）の未実装

#### 2. トーストメッセージの表示問題
- CSSクラス名の不一致
- 表示タイミングの問題

#### 3. 状態管理の問題
- localStorageへの保存処理の不備
- ページリロード後の状態復元処理の問題

#### 4. パフォーマンスの問題
- 応答時間が期待値を超過（14.4秒 vs 5秒、5.0秒 vs 3秒）

### 修正が必要な項目

#### 1. Ethers.jsモックの改善
```typescript
// 必要な追加モック
- eth_newFilter: フィルター作成のモック
- eth_call: コントラクト呼び出しのモック
- eth_blockNumber: ブロック番号取得のモック
- イベントエミッター機能の実装
```

#### 2. トーストメッセージの修正
```typescript
// トーストコンポーネントのCSSクラス確認
// トースト表示タイミングの調整
// エラーメッセージの統一
```

#### 3. 状態管理の改善
```typescript
// localStorageへの保存処理の確認
// ページリロード後の状態復元処理の修正
// ウォレット接続状態の適切な管理
```

#### 4. パフォーマンステストの調整
```typescript
// タイムアウト値の調整（5秒→10秒、3秒→6秒）
// モック処理の最適化
// 非同期処理の効率化
```

## 次の実装予定ファイル

- `simple-vote-next/tests/wallet-connection.spec.ts` - ウォレット接続テスト（修正）
- `simple-vote-next/tests/poll-creation.spec.ts` - 投票作成テスト
- `simple-vote-next/tests/dynamic-vote.spec.ts` - Dynamic Voteテスト
- `simple-vote-next/tests/weighted-vote.spec.ts` - Weighted Voteテスト
- `simple-vote-next/tests/simple-vote.spec.ts` - Simple Voteテスト

## テスト実行コマンド

```bash
# 基本UI・ナビゲーションテスト実行
npx playwright test basic-ui-navigation.spec.ts --reporter=list --project=chromium

# ウォレット接続テスト実行
npx playwright test wallet-connection.spec.ts --reporter=list --project=chromium

# 全テスト実行
npx playwright test --reporter=list --project=chromium

# 特定のテストのみ実行
npx playwright test --grep="ウォレット接続" --reporter=list --project=chromium
```