# SimpleVote Next.js アプリケーション Playwright テスト計画

## 概要
SimpleVoteは、ブロックチェーン上で投票を行うDApp（分散型アプリケーション）です。このドキュメントでは、Next.jsで構築されたフロントエンドアプリケーションのPlaywrightテスト項目を網羅的にまとめています。

## テスト環境設定

### 必要な依存関係
```json
{
  "devDependencies": {
    "@playwright/test": "^1.40.0",
    "playwright": "^1.40.0"
  }
}
```

### テスト設定ファイル
- `playwright.config.ts` - Playwrightの設定
- `tests/` - テストファイル格納ディレクトリ

## テストファイル一覧

### 実装済みテストファイル
- `basic-ui-navigation.spec.ts` - 基本UI・ナビゲーションテスト
- `basic-ui-navigation-with-helpers.spec.ts` - ヘルパー関数を使用した基本UIテスト
- `wallet-connection.spec.ts` - ウォレット接続テスト
- `wallet-error-handling.spec.ts` - ウォレットエラーハンドリングテスト
- `wallet-performance.spec.ts` - ウォレットパフォーマンステスト
- `wallet-state-management.spec.ts` - ウォレット状態管理テスト
- `poll-creation.spec.ts` - 投票作成テスト
- `debug-wallet.spec.ts` - ウォレットデバッグテスト

### ヘルパーファイル
- `helpers/ethers-mock.ts` - ethers.jsモック実装
- `helpers/global-setup.ts` - グローバルセットアップ
- `helpers/global-teardown.ts` - グローバルティアダウン
- `helpers/wallet-helper.ts` - ウォレット操作ヘルパー

### 未実装テストファイル（予定）
- `dynamic-vote.spec.ts` - Dynamic Voteテスト
- `weighted-vote.spec.ts` - Weighted Voteテスト
- `simple-vote.spec.ts` - Simple Voteテスト
- `toast-notification.spec.ts` - トースト通知テスト
- `responsive-design.spec.ts` - レスポンシブデザインテスト
- `performance.spec.ts` - パフォーマンステスト
- `security.spec.ts` - セキュリティテスト
- `browser-compatibility.spec.ts` - ブラウザ互換性テスト
- `error-scenarios.spec.ts` - エラーシナリオテスト

## テスト項目一覧

### 1. 基本UI・ナビゲーションテスト

**テストファイル**: `basic-ui-navigation.spec.ts`, `basic-ui-navigation-with-helpers.spec.ts`

#### 1.1 ホームページ（`/`）
- [x] ページタイトル「SimpleVote」が表示される
- [x] ウォレット未接続時に「ウォレット接続」ボタンが表示される
- [x] ウォレット未接続時にアカウントアドレスが表示されない
- [x] ウォレット未接続時に「切断」ボタンが表示されない
- [x] ウォレット未接続時に「新規作成」ボタンが表示されない
- [x] ウォレット未接続時に投票一覧セクションが表示されない
- [x] ウォレット接続後にアカウントアドレスが表示される
- [x] ウォレット接続後に「切断」ボタンが表示される
- [x] ウォレット接続後に「新規作成」ボタンが表示される
- [x] ウォレット接続後に投票一覧セクションが表示される
- [x] 投票が存在しない場合「議題が存在しません」が表示される
- [x] 投票一覧の各項目が正しく表示される（タイプ、トピック、ID）
- [x] 投票項目をクリックすると対応する投票ページに遷移する

#### 1.2 ページヘッダー・ナビゲーション
- [x] パンくずリストが正しく表示される
- [x] ホームボタンが正しく機能する
- [x] ホームページのタイトル表示（ウォレット未接続時）
- [x] ホームページのタイトル表示（ウォレット接続時）

#### 1.3 ローディング状態
- [x] データ読み込み中にLoadingSpinnerが表示される
- [x] 読み込み完了後にコンテンツが表示される

#### 1.4 エラーハンドリング
- [x] エラー時に適切なエラーメッセージが表示される
- [x] 無効なPoll IDでアクセスした場合のエラー表示
- [x] コントラクトアドレス未設定時のエラー表示

### 2. ウォレット接続テスト

**テストファイル**: `wallet-connection.spec.ts`, `wallet-error-handling.spec.ts`, `wallet-performance.spec.ts`, `wallet-state-management.spec.ts`

#### 2.1 MetaMask接続
- [x] 接続成功後のアカウントアドレス表示
- [x] 接続成功後のUI状態確認
- [x] 複数回の接続試行
- [x] ウォレット接続ボタンクリック時の動作
- [x] 接続成功後のトーストメッセージ表示
- [x] モック環境でのウォレット接続動作確認
- [x] MetaMaskがインストールされていない場合のエラーメッセージ

#### 2.2 ウォレット切断
- [x] 切断ボタンクリック時の動作
- [x] 切断後の状態リセット
- [x] 切断後の再接続
- [x] 切断後のトーストメッセージ表示
- [x] モック環境での切断動作確認

#### 2.3 ウォレット状態管理
- [ ] ページリロード後のウォレット状態保持
- [ ] アカウント切り替え時の状態更新
- [ ] ネットワーク切り替え時の状態更新
- [ ] ウォレット接続状態の永続化

#### 2.4 エラーハンドリング
- [x] MetaMaskがインストールされていない場合のエラーメッセージ
- [x] ユーザーが接続を拒否した場合のエラーハンドリング
- [x] ネットワークエラー時のエラーハンドリング
- [x] 無効なネットワークへの接続時のエラーハンドリング
- [x] 予期しないエラーの適切な処理
- [x] エラー後の再接続試行機能
- [x] エラー状態の適切なリセット

#### 2.5 パフォーマンステスト
- [ ] ウォレット接続の応答時間
- [ ] 複数回接続時のパフォーマンス

#### 2.6 セキュリティテスト
- [x] アカウントアドレスの適切な表示
- [x] 接続状態の適切な検証
- [x] 不正なアカウントアドレスの検証
- [x] モックアカウントアドレスの表示確認

#### 2.7 アクセシビリティテスト
- [x] ウォレット接続ボタンのアクセシビリティ
- [x] 切断ボタンのアクセシビリティ
- [x] アカウントアドレス表示のアクセシビリティ

### 3. 投票作成テスト（`/create`）

**テストファイル**: `poll-creation.spec.ts`

#### 3.1 フォーム表示
- [x] 投票タイプ選択（Dynamic Vote、Weighted Vote、Simple Vote）
- [x] 議題入力フィールド
- [x] 開始日時・終了日時入力フィールド
- [x] 選択肢入力フィールド（初期値2個）
- [x] 選択肢追加ボタン（最大10個まで）
- [x] Weighted Vote選択時のトークンアドレス入力フィールド

#### 3.2 フォームバリデーション
- [x] 必須項目の入力チェック
- [x] 日時の妥当性チェック（終了日時 > 開始日時）
- [x] トークンアドレスの形式チェック
- [x] 選択肢の空文字チェック
- [x] 選択肢の重複チェック
- [x] 無効なトークンアドレスのエラーメッセージ表示

#### 3.3 フォーム操作
- [x] 投票タイプ変更時のUI更新
- [x] 選択肢の追加・削除（最大10個まで）
- [x] 日時の自動設定（現在時刻から1時間後）
- [x] 選択肢追加ボタンの無効化（最大数到達時）
- [ ] フォームリセット機能

#### 3.4 投票作成実行
- [x] Dynamic Vote作成
- [x] Weighted Vote作成
- [x] Simple Vote作成
- [x] 作成ボタンクリック時のトランザクション実行
- [x] トランザクション承認待ち状態の表示
- [x] 作成成功後のトーストメッセージ
- [x] 作成成功後のホームページリダイレクト
- [x] エラー時の適切なエラーメッセージ表示
- [x] フォームバリデーション（必須項目、日時、トークンアドレス）
- [x] 選択肢の追加・削除機能
- [x] 投票タイプ変更時のUI更新
- [x] トランザクションエラーハンドリング

### 4. Dynamic Vote テスト（`/dynamic/[pollId]`）

**テストファイル**: `dynamic-vote.spec.ts`（未実装）

#### 4.1 ページ表示
- [ ] 投票タイトル「DynamicVote」の表示
- [ ] 議題内容の表示
- [ ] 開始・終了日時の表示
- [ ] 選択肢一覧の表示
- [ ] 各選択肢の投票数表示

#### 4.2 投票期間チェック
- [ ] 投票期間内の投票ボタン有効化
- [ ] 投票期間外の投票ボタン無効化
- [ ] 投票期間外メッセージの表示

#### 4.3 投票操作
- [ ] 選択肢の選択
- [ ] 投票ボタンクリック時のトランザクション実行
- [ ] 投票成功後のトーストメッセージ
- [ ] 投票後の選択肢無効化
- [ ] 投票取消ボタンの表示
- [ ] 投票取消の実行

#### 4.4 リアルタイム更新
- [ ] 投票後の投票数更新
- [ ] イベントリスナーによる自動更新
- [ ] 他のユーザーの投票反映

### 5. Weighted Vote テスト（`/weighted/[pollId]`）

**テストファイル**: `weighted-vote.spec.ts`（未実装）

#### 5.1 ページ表示
- [ ] 投票タイトル「WeightedVote DApp」の表示
- [ ] 議題内容の表示
- [ ] 開始・終了日時の表示
- [ ] 選択肢一覧の表示
- [ ] 各選択肢の投票数表示（Ether表記）

#### 5.2 トークン承認
- [ ] 投票金額入力フィールド
- [ ] トークン承認ボタンの表示
- [ ] 承認実行時のトランザクション
- [ ] 承認成功後のトーストメッセージ

#### 5.3 投票操作
- [ ] 選択肢の選択
- [ ] 投票金額の入力
- [ ] 投票ボタンクリック時のトランザクション実行
- [ ] 投票成功後のトーストメッセージ
- [ ] 投票後の選択肢無効化
- [ ] 投票取消ボタンの表示
- [ ] 投票取消の実行

#### 5.4 金額バリデーション
- [ ] 無効な金額入力のエラーハンドリング
- [ ] 残高不足時のエラーメッセージ
- [ ] 承認額不足時のエラーメッセージ

### 6. Simple Vote テスト（`/simple/[pollId]`）

**テストファイル**: `simple-vote.spec.ts`（未実装）

#### 6.1 ページ表示
- [ ] 投票タイトル「SimpleVote」の表示
- [ ] 議題内容の表示
- [ ] 開始・終了日時の表示
- [ ] 賛成・反対の選択肢表示
- [ ] 賛成・反対の投票数表示

#### 6.2 投票操作
- [ ] 賛成・反対の選択
- [ ] 投票ボタンクリック時のトランザクション実行
- [ ] 投票成功後のトーストメッセージ
- [ ] 投票後の選択肢無効化
- [ ] 投票取消ボタンの表示
- [ ] 投票取消の実行

### 7. トースト通知テスト

**テストファイル**: `toast-notification.spec.ts`（未実装）

#### 7.1 トースト表示
- [x] 成功メッセージの表示
- [x] エラーメッセージの表示
- [x] トランザクション承認待ちメッセージの表示
- [ ] トーストの自動消去

#### 7.2 トースト操作
- [x] 複数トーストの同時表示
- [ ] トーストの手動閉じる機能

### 8. レスポンシブデザインテスト

**テストファイル**: `responsive-design.spec.ts`（未実装）

#### 8.1 画面サイズ対応
- [x] デスクトップ表示（1920x1080）
- [x] タブレット表示（768x1024）
- [x] モバイル表示（375x667）
- [x] 各画面サイズでのUI要素の配置確認

#### 8.2 タッチ操作
- [ ] モバイルでのタップ操作
- [ ] スワイプ操作の確認

### 9. パフォーマンステスト

**テストファイル**: `performance.spec.ts`（未実装）

#### 9.1 ページ読み込み
- [x] 初期ページ読み込み時間
- [x] 投票一覧取得時間
- [ ] 投票詳細取得時間

#### 9.2 メモリ使用量
- [ ] 長時間使用時のメモリリーク確認
- [ ] イベントリスナーの適切なクリーンアップ

### 10. セキュリティテスト

**テストファイル**: `security.spec.ts`（未実装）

#### 10.1 入力値検証
- [ ] XSS攻撃対策
- [ ] SQLインジェクション対策（該当する場合）
- [ ] 特殊文字の適切なエスケープ

#### 10.2 認証・認可
- [ ] 未認証ユーザーのアクセス制限
- [ ] 権限のない操作の制限

### 11. ブラウザ互換性テスト

**テストファイル**: `browser-compatibility.spec.ts`（未実装）

#### 11.1 対応ブラウザ
- [x] Chrome
- [x] Firefox
- [x] Safari
- [x] Edge

#### 11.2 機能確認
- [x] 各ブラウザでの基本機能動作
- [x] 各ブラウザでのUI表示確認

### 12. エラーシナリオテスト

**テストファイル**: `error-scenarios.spec.ts`（未実装）

#### 12.1 ネットワークエラー
- [x] ネットワーク切断時のエラーハンドリング
- [x] ネットワーク復旧時の自動再接続

#### 12.2 コントラクトエラー
- [x] コントラクト呼び出し失敗時のエラーハンドリング（getPolls()デコードエラー）
- [ ] ガス不足時のエラーメッセージ
- [ ] 無効なトランザクションのエラーハンドリング
- [ ] イベントリスナーエラーの適切な処理（eth_getFilterChanges未実装）

#### 12.3 ユーザーエラー
- [ ] 無効な入力値のエラーハンドリング
- [ ] 重複投票の防止
- [ ] 投票期間外の投票防止

## テスト実装の優先順位

### 高優先度（必須）✅ 完了
1. ✅ 投票作成テスト（完全完了）
2. ✅ ウォレットエラーハンドリングテスト（完全完了）
3. 各投票タイプの基本機能テスト
4. コントラクトエラーハンドリングの改善

### 中優先度（重要）
1. ✅ エラーハンドリングテスト（ウォレット関連完了）
2. トースト通知テスト
3. セキュリティテスト

### 低優先度（推奨）
1. パフォーマンステスト
2. エラーシナリオテスト

## 修正完了項目

### 投票作成テスト（`/create`）✅ **完全完了**
- ✅ ページの基本表示
- ✅ フォームバリデーション
- ✅ Dynamic Vote作成
- ✅ Weighted Vote作成
- ✅ Simple Vote作成
- ✅ 選択肢の追加・削除
- ✅ トランザクションエラーハンドリング
- ✅ 投票タイプ変更時のUI更新
- ✅ 戻るボタンの動作
- ✅ トランザクション承認待ち状態の表示

### ウォレットエラーハンドリングテスト ✅ **完全完了**
- ✅ MetaMask未インストール時のエラーハンドリング
- ✅ ウォレット接続拒否時のエラーハンドリング
- ✅ ネットワークエラー時のエラーハンドリング
- ✅ 予期しないエラーの適切な処理
- ✅ エラー後の再接続試行機能
- ✅ エラー状態の適切なリセット
- ✅ エラーメッセージの適切な表示
- ✅ トースト通知によるエラー表示

## テストデータ準備

### テスト用アカウント
- テスト用ウォレットアカウント（複数）
- テスト用トークン残高

### テスト用投票データ
- Dynamic Vote用のテスト投票
- Weighted Vote用のテスト投票
- Simple Vote用のテスト投票
- 投票期間内・期間外のテストデータ

### モックデータ
- コントラクトレスポンスのモック
- ネットワークエラーのモック
- トランザクション失敗のモック

## テスト実行環境

### ローカル環境
- Hardhatローカルネットワーク
- MetaMaskテストネットワーク接続
- テスト用アカウントの設定

### モック環境
- ethers.jsの完全なモック実装
- ウォレット接続のモックテスト
- コントラクト呼び出しのモックテスト

### CI/CD環境
- GitHub Actionsでの自動テスト実行
- テスト結果のレポート生成
- カバレッジレポートの生成

## 注意事項

1. **ブロックチェーン操作**: 実際のトランザクションを実行するため、テスト用のネットワークを使用
2. **非同期処理**: ブロックチェーンの確認待ち時間を考慮したテスト設計
3. **状態管理**: ウォレット接続状態や投票状態の適切な管理
4. **エラーハンドリング**: ネットワークエラーやコントラクトエラーの適切な処理
5. **テストデータ**: テスト用の投票データやアカウントの準備
6. **モック環境**: ethers.jsのモックが適切に設定されていることを確認
7. **コントラクトエラー**: getPolls()メソッドのデコードエラーが発生する可能性がある
8. **イベントリスナー**: eth_getFilterChangesメソッドのモック実装が必要

## 修正済み問題

### 投票作成テストの修正完了
- **Toast要素の重複問題**: 最新のトーストのみを検証するように修正
- **フォームセレクタの不一致**: `input[name="end"]`を`input[type="datetime-local"]`に修正
- **選択肢入力の部分一致問題**: 完全一致セレクタに修正
- **BigNumberishエラー**: 日時設定の改善とモックのバリデーション追加により解決
- **日時設定の問題**: 開始時刻（現在）と終了時刻（1時間後）を適切に設定

### ウォレットエラーハンドリングテストの修正完了
- **エラーシミュレーション**: 各種エラーケースの適切なモック実装
- **エラーメッセージ表示**: トースト通知による適切なエラー表示
- **エラー状態管理**: エラー後の状態リセットと再接続機能
- **モック環境**: ethers.jsの完全なモックによる安定したテスト実行

### テスト成功率の改善
修正前: 多数のテストが失敗（BigNumberishエラー、セレクタ問題等）
修正後: 投票作成テストとウォレットエラーハンドリングテストの全項目が正常に動作することを確認

## 次回テスト実行予定項目

### 優先度1: 各投票タイプの基本機能テスト
1. Dynamic Vote テスト（`/dynamic/[pollId]`）
2. Weighted Vote テスト（`/weighted/[pollId]`）
3. Simple Vote テスト（`/simple/[pollId]`）

### 優先度2: 残りのエラーハンドリングテスト
1. コントラクトエラーの詳細テスト
2. ユーザーエラーのテスト
3. トースト通知の完全テスト

### 優先度3: パフォーマンス・セキュリティテスト
1. パフォーマンステスト
2. セキュリティテスト
3. ブラウザ互換性の詳細テスト
