# トランザクション完了後の処理が止まる問題 - 原因特定方法

## 問題の概要
Dynamic Vote作成テストで、トランザクション完了後に「議題を作成しました」トーストが表示されず、「トランザクション承認待ち…」のまま処理が止まる問題が発生しています。

## 原因特定のアプローチ

### 1. イベントログの詳細検証

#### 1.1 アプリ側でのイベント処理ログ追加
**対象ファイル**: `app/create/page.tsx`

**追加すべきログ**:
```typescript
// トランザクション完了後の処理で
console.log('Transaction receipt:', receipt);
console.log('Transaction logs:', receipt.logs);

// イベントパース処理で
try {
  const parsedLog = registry.interface.parseLog(log);
  console.log('Parsed log:', parsedLog);
} catch (error) {
  console.error('Log parsing error:', error);
}
```

**確認ポイント**:
- 実際に受信しているログの形式
- `parseLog`が正常に動作しているか
- パースされたイベントデータの内容

#### 1.2 モックログの形式検証
**対象ファイル**: `tests/helpers/ethers-mock.ts`

**検証項目**:
- 現在のモックログがアプリ側の期待と一致しているか
- `topics`の順序と内容が正しいか
- `data`フィールドの形式が適切か

### 2. アプリ側のイベント処理ロジック確認

#### 2.1 イベント検知の流れ追跡
**対象ファイル**: `app/create/page.tsx`

**確認すべき処理**:
1. トランザクション完了後の`receipt.logs`の処理
2. `PollCreated`イベントの検知ロジック
3. イベント検知後のトースト表示処理

**追加すべきデバッグポイント**:
```typescript
// 各ステップでログを追加
console.log('Processing transaction receipt...');
console.log('Looking for PollCreated event...');
console.log('Event found, updating toast...');
```

#### 2.2 トースト表示の条件確認
**対象ファイル**: `components/Toast.tsx` または関連コンポーネント

**確認項目**:
- トースト表示のトリガー条件
- 状態管理の流れ
- エラーハンドリング

### 3. モックの完全性検証

#### 3.1 モック適用状況の確認
**対象ファイル**: `tests/helpers/ethers-mock.ts`

**検証項目**:
- モックが確実に適用されているか
- アプリ側で実際のethers.jsではなくモックが使用されているか
- モックの再適用が正常に動作しているか

**追加すべき検証**:
```typescript
// モック適用確認
console.log('Mock ethers applied:', typeof ethers);
console.log('Mock contract interface:', registry.interface);
```

#### 3.2 モックデータの整合性確認
**検証項目**:
- `createPoll`の戻り値が期待される形式か
- `getPolls`のダミーデータが正しくデコードされるか
- イベントシグネチャが正しく計算されているか

### 4. 段階的デバッグ手法

#### 4.1 最小限のテストケース作成
**目的**: 問題を最小限に絞り込む

**手順**:
1. トランザクション送信のみのテスト
2. イベント検知のみのテスト
3. トースト表示のみのテスト

#### 4.2 実際のブロックチェーンとの比較
**目的**: モックと実際の動作の差異を特定

**手順**:
1. ローカルネットワークで実際のトランザクションを実行
2. 実際のログとモックログを比較
3. 差異があればモックを修正

### 5. 具体的な調査手順

#### ステップ1: アプリ側のログ追加
1. `app/create/page.tsx`にデバッグログを追加
2. テストを実行してログを確認
3. 実際の処理フローを把握

#### ステップ2: モックログの検証
1. 現在のモックログの形式を詳細に確認
2. アプリ側の期待する形式と比較
3. 必要に応じてモックを修正

#### ステップ3: イベント処理ロジックの確認
1. イベント検知の各ステップでログを追加
2. どの段階で処理が止まっているかを特定
3. 問題のある箇所を修正

#### ステップ4: 統合テスト
1. 修正後のテストを実行
2. エンドツーエンドの動作を確認
3. 必要に応じて追加修正

## 期待される結果

### 成功パターン
1. トランザクション完了後に`PollCreated`イベントが正しく検知される
2. イベント検知後に「議題を作成しました」トーストが表示される
3. テストが正常に完了する

### 失敗パターンの対処
1. **イベントが検知されない場合**: モックログの形式を修正
2. **パースエラーが発生する場合**: イベントシグネチャを確認
3. **トーストが表示されない場合**: 状態管理ロジックを確認

## 技術的考慮事項

### デバッグ時の注意点
- コンソールログは一時的なものとして追加
- 本番環境では削除することを前提
- 機密情報がログに出力されないよう注意

### モックの保守性
- モックの修正は他のテストに影響しないよう注意
- 変更履歴を記録
- 必要に応じてモックのバージョン管理を検討

---

**作成日**: 2024年12月19日  
**対象問題**: トランザクション完了後の処理が止まる問題  
**関連ファイル**: 
- `tests/poll-creation.spec.ts`
- `tests/helpers/ethers-mock.ts`
- `app/create/page.tsx` 