# Twitter風投票アプリケーション仕様

このドキュメントは、SimpleVoteプロジェクトをベースにしたTwitter風の分散型投票アプリケーションの機能と技術仕様を詳述します。既存の`PollRegistry`スマートコントラクトとReactフロントエンドを活用し、ユーザーフレンドリーな投票体験を提供することを目指します。

## 1. 目的

ユーザーが簡単に投票を作成し、他のユーザーの投票に参加し、リアルタイムで結果を確認できる、直感的で効率的な投票アプリケーションを構築します。ブロックチェーン技術の透明性と不変性を活かしつつ、一般的なソーシャルメディアの投票機能に匹敵する使いやすさを実現します。

## 2. 主要機能

### 2.1. ウォレット接続と認証

*   **MetaMask連携**: ユーザーはMetaMaskを通じてアプリケーションに接続し、自身のウォレットアドレスで認証を行います。
*   **アカウント表示**: 接続中のウォレットアドレスをUIに表示します。
*   **切断機能**: ユーザーはいつでもウォレット接続を切断できます。

### 2.2. 投票の作成

ユーザーは以下の情報を指定して新しい投票を作成できます。
*   **議題（トピック）**: 投票の主題となる質問や内容（テキスト入力）。
*   **投票タイプ**:
    *   **SimpleVote**: 「賛成/反対」のような固定された2つの選択肢を持つシンプルな投票。
    *   **DynamicVote**: オーナーが事前に定義した複数の選択肢（2〜10個）を持つ投票。
    *   **WeightedVote**: ERC20トークンをステークすることで投票に重み付けができる投票。トークンアドレスの指定が必要です。
*   **選択肢**:
    *   DynamicVoteおよびWeightedVoteの場合、ユーザーは2〜10個の選択肢をテキストで入力できます。
    *   SimpleVoteの場合、選択肢は「Yes/No」または「賛成/反対」のように固定されます。
*   **投票期間**: 投票の開始日時と終了日時（UNIXタイムスタンプに変換）。終了日時は開始日時より後である必要があります。

### 2.3. 投票の一覧表示

*   **全投票の表示**: `PollRegistry`コントラクトに登録されている全ての投票を一覧で表示します。
*   **投票情報の概要**: 各投票について、以下の情報を表示します。
    *   投票ID
    *   投票タイプ（Dynamic, Weighted, Simple）
    *   議題（トピック）
    *   作成者（オーナーアドレス）
    *   現在の投票ステータス（進行中、終了済み）
*   **フィルタリング/ソート**: 将来的には、投票タイプ、ステータス、作成者などでフィルタリングやソート機能を追加することを検討します。
*   **非表示機能**: ユーザーは特定の投票をフロントエンドから非表示にできます（`localStorage`に保存し、ブロックチェーン上のデータは変更しない）。非表示にした投票は一覧に表示されなくなります。

### 2.4. 投票への参加

*   **投票選択**: ユーザーは表示された選択肢の中から1つを選んで投票できます。
*   **重み付け投票**: WeightedVoteの場合、ユーザーは投票するトークン量を入力し、事前にトークンの承認（Approve）を行う必要があります。
*   **投票期間の制限**: 投票期間外（開始前または終了後）は投票できません。
*   **二重投票の防止**: 同じ投票に対して複数回投票することはできません。
*   **投票のキャンセル**: 投票期間中であれば、ユーザーは自身の投票を取り消すことができます。WeightedVoteの場合、ステークしたトークンが返還されます。

### 2.5. 投票結果の表示

*   **リアルタイム更新**: 投票が行われるたびに、各選択肢の票数（WeightedVoteの場合はトークン量）と割合がリアルタイムで更新されます。
*   **ユーザーの投票状況**: ユーザーがその投票に既に投票している場合、どの選択肢に投票したかを表示します。
*   **終了後の結果**: 投票期間が終了した投票についても、最終結果を表示します。

### 2.6. トースト通知

*   トランザクションの承認待ち、成功、失敗、エラーなどの重要なユーザーアクションに対して、画面上部に一時的なトースト通知を表示します。

## 3. UI/UXデザインの考慮事項

*   **シンプルで直感的なインターフェース**: Twitterの投票機能のように、ユーザーが迷わず操作できるデザインを心がけます。
*   **レスポンシブデザイン**: モバイルデバイスでも快適に利用できるよう、レスポンシブなレイアウトを適用します。
*   **視覚的なフィードバック**: ボタンのローディング状態、成功/失敗のメッセージ、投票結果のグラフ表示（将来的）など、ユーザーに明確なフィードバックを提供します。
*   **Tailwind CSSの活用**: 既存のTailwind CSSを最大限に活用し、統一されたデザインを維持します。

## 4. 技術スタックとコンポーネント

### 4.1. スマートコントラクト

*   **`contracts/PollRegistry.sol`**: 全ての投票ロジック（作成、投票、キャンセル、情報取得）を管理する単一のコントラクト。
    *   `PollType` enum: `DYNAMIC_VOTE`, `WEIGHTED_VOTE`, `SIMPLE_VOTE` を定義。
    *   `Poll` struct: 各投票の詳細データ（トピック、期間、選択肢、投票者マッピングなど）を保持。
    *   `createPoll()`: 新しい投票を作成。
    *   `vote()`: 投票を行う。
    *   `cancelVote()`: 投票をキャンセル。
    *   `getPolls()`: 全ての投票の概要を取得。
    *   `getPoll(uint256 _pollId)`: 特定の投票の詳細を取得。
    *   `getVotedChoiceId(uint256 _pollId, address _voter)`: 特定の投票者がどの選択肢に投票したかを取得。
*   **`contracts/MockERC20.sol`**: WeightedVoteで使用するモックERC20トークン。

### 4.2. フロントエンド (`simple-vote-ui/src`)

*   **`App.jsx`**: アプリケーションのメインコンポーネント。ウォレット接続、ページルーティング、トースト通知を管理します。
*   **`PollListPage.jsx`**: 投票一覧と新規作成ボタンを含むページ。
*   **`PollList.jsx`**: `PollRegistry`から投票データをフェッチし、一覧表示するコンポーネント。
    *   `localStorage`を利用して非表示設定を永続化します。
    *   各投票のオーナーと現在のユーザーアドレスを比較し、オーナーにのみ「削除（非表示）」ボタンを表示します。
*   **`PollCreate.jsx`**: 新しい投票を作成するためのフォームコンポーネント。`PollRegistry.createPoll`を呼び出します。
*   **`DynamicVote.jsx`**: DynamicVoteタイプの投票詳細と投票ロジックを扱うコンポーネント。`PollRegistry.vote`および`cancelVote`を呼び出します。
*   **`WeightedVote.jsx`**: WeightedVoteタイプの投票詳細と投票ロジックを扱うコンポーネント。`PollRegistry.vote`および`cancelVote`、ERC20の`approve`を呼び出します。
*   **`SimpleVote.jsx`**: SimpleVoteタイプの投票詳細と投票ロジックを扱うコンポーネント。`PollRegistry.vote`および`cancelVote`を呼び出します。
*   **`constants.js`**: `PollRegistry`および`MockERC20`のコントラクトアドレスとABIを定義。
*   **`Toast.jsx`**: 汎用的なトースト通知コンポーネント。

### 4.3. データフロー

1.  **ウォレット接続**: `App.jsx` -> `ethers.js` -> MetaMask
2.  **投票作成**: `PollCreate.jsx` -> `ethers.js` -> `PollRegistry.createPoll()`
3.  **投票一覧取得**: `PollList.jsx` -> `ethers.js` -> `PollRegistry.getPolls()` および `PollRegistry.getPoll()`
4.  **投票/キャンセル**: `DynamicVote.jsx`, `WeightedVote.jsx`, `SimpleVote.jsx` -> `ethers.js` -> `PollRegistry.vote()` / `PollRegistry.cancelVote()`
5.  **トークン承認**: `WeightedVote.jsx` -> `ethers.js` -> `MockERC20.approve()`
6.  **イベントリスニング**: 各投票コンポーネントは`PollRegistry`の`VoteCast`、`VoteCancelled`イベントをリッスンし、UIを更新します。`PollList`は`PollCreated`イベントをリッスンします。

## 5. 今後の拡張

*   **投票の検索機能**: 議題や作成者による検索。
*   **通知機能**: 投票期間の終了や新しい投票の作成通知。
*   **グラフ表示**: 投票結果を円グラフや棒グラフで視覚的に表示。
*   **コメント機能**: 各投票に対するコメント機能（オフチェーンまたはオンチェーン）。
*   **ガス代見積もり**: トランザクション実行前にガス代の概算を表示。
*   **ページネーション**: 投票数が増えた際の一覧表示の最適化。

この仕様は、SimpleVoteプロジェクトの既存の強みを活かしつつ、よりリッチでユーザーフレンドリーな投票アプリケーションを構築するための基盤となります。
